<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-us">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Comparing different ways to add ints II | Software and puns</title>



<link href="http://petr-tik.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Software and puns" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="http://petr-tik.github.io/posts/sum_ints_as_arrays_part_two/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="http://petr-tik.github.io/">
          <h1 class="title is-4">Software and puns</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/petr-tik'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/petr_tik'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">whoami</h2>
        </a></div>
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/python">#python</a>



      
    </div>
    <h2 class="subtitle is-6">July 16, 2017</h2>
    <h1 class="title">Comparing different ways to add ints II</h1>
    
    <div class="content">
      

<h2 id="background">Background</h2>

<p>As outlined in <a href="http://petr-tik.github.io/posts/sum_ints_as_arrays_part_one/">part 1</a>, we are comparing recursive and iterative implementations of long arithmetic of 2 arrays. As seen in the chart at the bottom of the post, there is a sudden jump in execution times of the recursive function, when the length of array becomes ~900 ints. Using the <code>cProfile</code> and <code>line_profile</code> modules in Python, this increase in execution times is investigated in this post. First cProfile was used to record and examine the execution times for <code>recur_sum</code> and <code>iter_sum</code>. After the bottlenecks were located, <code>line_profiler</code> was used to profile each function with higher granularity. To guarantee consistent analysis both implementations will be benchmarked with line profiling enabled.</p>

<h2 id="refactoring">Refactoring</h2>

<p>The script from part 1 had to be changed to profile the relevant function calls and save the results. This effectively wraps the function calls with cProfiler and then saves the results into a .dmp type. Afterwards results are plotted.</p>

<h3 id="plot-results">Plot results</h3>

<p>Instead of using a scatter plot, normal plot was used, which made the increase in gradient more obvious. It also takes the right and left limits to the x values (lengths of the array). Setting xlim to the plot will help us focus the picture. We will not exceed recursion depth in this example. Hence we won&rsquo;t be marking the last point in recursive times.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">plot_results_for_cprofile</span>(xs, ys, r_limit, l_limit):
    plt<span style="color:#666">.</span>xlim(r_limit, l_limit)
    plt<span style="color:#666">.</span>xlabel(<span style="color:#b44">&#39;Size of input arrays&#39;</span>)
    plt<span style="color:#666">.</span>ylabel(<span style="color:#b44">&#39;Time to calculate sum (ms)&#39;</span>)
    plt<span style="color:#666">.</span>title(<span style="color:#b44">&#39;Comparing iterative vs recursive sum methods&#39;</span>)

    iter_arr_lengths, recur_arr_lengths <span style="color:#666">=</span> xs
    iters, recurs <span style="color:#666">=</span> ys

    <span style="color:#080;font-style:italic"># plot iterative times</span>
    plt<span style="color:#666">.</span>plot(np<span style="color:#666">.</span>array(iter_arr_lengths), np<span style="color:#666">.</span>array(iters), c<span style="color:#666">=</span><span style="color:#b44">&#34;red&#34;</span>)

    <span style="color:#080;font-style:italic"># plot recursive times</span>
    plt<span style="color:#666">.</span>plot(np<span style="color:#666">.</span>array(recur_arr_lengths), np<span style="color:#666">.</span>array(recurs), c<span style="color:#666">=</span><span style="color:#b44">&#34;green&#34;</span>)

    fname <span style="color:#666">=</span> <span style="color:#b44">&#34;plot_sum_ints.png&#34;</span>
    plt<span style="color:#666">.</span>savefig(fname, dpi<span style="color:#666">=</span><span style="color:#666">1200</span>)
    <span style="color:#a2f;font-weight:bold">print</span>(<span style="color:#b44">&#34;Saved plot as {}&#34;</span><span style="color:#666">.</span>format(fname))</code></pre></div>
<h3 id="profile-run">Profile run</h3>

<p>Profile run method instantiates 2 <code>cProfile.Profile()</code> classes for iterative and recursive solution profiling. Looping over different array lengths, the <code>iter_sum</code> and <code>recur_sum</code> solutions are profiled. The profiling information is saved to disk using the <code>dump_stats()</code> method, which takes a string for argument name.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">profile_run</span>(r_limit, l_limit):
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">cProfile</span>
    iter_arr_lengths <span style="color:#666">=</span> []
    recur_arr_lengths <span style="color:#666">=</span> []
    iter_times <span style="color:#666">=</span> []
    recur_times <span style="color:#666">=</span> []

    <span style="color:#a2f;font-weight:bold">for</span> arr_length <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#a2f">range</span>(r_limit, l_limit, <span style="color:#666">1</span>):
        arr1 <span style="color:#666">=</span> [<span style="color:#666">9</span> <span style="color:#a2f;font-weight:bold">for</span> _ <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#a2f">range</span>(arr_length)]
        arr2 <span style="color:#666">=</span> [<span style="color:#666">1</span> <span style="color:#a2f;font-weight:bold">for</span> _ <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#a2f">range</span>(arr_length)]

        pr <span style="color:#666">=</span> cProfile<span style="color:#666">.</span>Profile()
        pr2 <span style="color:#666">=</span> cProfile<span style="color:#666">.</span>Profile()

        pr<span style="color:#666">.</span>enable()
        res_iter, time_iter <span style="color:#666">=</span> iter_sum(arr1, arr2)
        pr<span style="color:#666">.</span>disable()
        pr<span style="color:#666">.</span>dump_stats(<span style="color:#b44">&#34;iter_{}&#34;</span><span style="color:#666">.</span>format(<span style="color:#a2f">str</span>(arr_length)))
        iter_arr_lengths<span style="color:#666">.</span>append(arr_length)
        iter_times<span style="color:#666">.</span>append(time_iter)

        pr2<span style="color:#666">.</span>enable()
        res_recur, time_recur <span style="color:#666">=</span> recur_sum(arr1, arr2)
        pr2<span style="color:#666">.</span>disable()
        pr2<span style="color:#666">.</span>dump_stats(<span style="color:#b44">&#34;recur_{}&#34;</span><span style="color:#666">.</span>format(<span style="color:#a2f">str</span>(arr_length)))
        recur_arr_lengths<span style="color:#666">.</span>append(arr_length)
        recur_times<span style="color:#666">.</span>append(time_recur)

    plot_results_for_cprofile([iter_arr_lengths, recur_arr_lengths],
                              [iter_times, recur_times], r_limit, l_limit)</code></pre></div>
<h3 id="dumping-stats">Dumping stats</h3>

<p>Used the length of input arrays as id of this profiler run. Looking at the <a href="https://github.com/python/cpython/blob/6f0eb93183519024cb360162bdd81b9faec97ba6/Lib/cProfile.py#L44-L48">source</a> for cProfile.Profile.dump_stats()</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">dump_stats</span>(self, <span style="color:#a2f">file</span>):
        <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">marshal</span>
        <span style="color:#a2f;font-weight:bold">with</span> <span style="color:#a2f">open</span>(<span style="color:#a2f">file</span>, <span style="color:#b44">&#39;wb&#39;</span>) <span style="color:#a2f;font-weight:bold">as</span> f:
            self<span style="color:#666">.</span>create_stats()
            marshal<span style="color:#666">.</span>dump(self<span style="color:#666">.</span>stats, f)</code></pre></div>
<p>We see that it uses the marshal module. From the <a href="https://docs.python.org/3/library/marshal.html">documentation</a>, we know that:</p>

<blockquote>
<p>Details of the format are undocumented on purpose; it may change between Python versions (although it rarely does).</p>

<p>This is not a general &ldquo;persistence&rdquo; module. For general persistence and transfer of Python objects through RPC calls, see the modules :mod:<code>pickle</code> and :mod:<code>shelve</code>. The :mod:<code>marshal</code> module exists mainly to support reading and writing the &ldquo;pseudo-compiled&rdquo; code for Python modules of :file:<code>.pyc</code> files. Therefore, the Python maintainers reserve the right to modify the marshal format in backward incompatible ways should the need arise. If you&rsquo;re serializing and de-serializing Python objects, use the :mod:<code>pickle</code> module instead &ndash; the performance is comparable, version independence is guaranteed, and pickle supports a substantially wider range of objects than marshal.</p>

<p>The :mod:<code>marshal</code> module is not intended to be secure against erroneous or maliciously constructed data. Never unmarshal data received from an untrusted or unauthenticated source.</p>
</blockquote>

<p>What joy! <code>cProfile</code> (the builtin python profiler) uses a badly documented, backwards-incompatible, insecure module with incomplete support for Python types.</p>

<h3 id="line-profiling">Line profiling</h3>

<p>Line profiling was implemented by changing the code for the <code>timeit</code> decorator function. This allowed repeat measurements to stay consistent between recursive and iterative methods. Assuming that the overhead of line profiling of the recursive and iterative solution is in the same order of magnitude, wrapping both <code>recur_sum</code> and <code>iter_sum</code> wasn&rsquo;t expected to change the difference between them too much. <code>recur_sum_helper</code> and <code>iter_sum_helper</code> had to be moved above <code>timeit</code> in the source code (reasons below).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">timeit</span>(func):
    str_func_to_profile <span style="color:#666">=</span> func<span style="color:#666">.</span>__code__<span style="color:#666">.</span>co_names[<span style="color:#666">0</span>]
    func_to_prof <span style="color:#666">=</span> <span style="color:#a2f">globals</span>()[str_func_to_profile]

    <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">newfunc</span>(<span style="color:#666">*</span>args, <span style="color:#666">**</span>kwargs):
        <span style="color:#080;font-style:italic"># locals() returns a dictionary, where &#39;args&#39; is key for local vars</span>
        <span style="color:#080;font-style:italic"># ASSUMPTION: both input arrays have the same length, use either</span>
        arr_length <span style="color:#666">=</span> <span style="color:#a2f">len</span>(<span style="color:#a2f">locals</span>()[<span style="color:#b44">&#39;args&#39;</span>][<span style="color:#666">0</span>])
        <span style="color:#080;font-style:italic"># make a new instance of LineProfiler for each time iter_sum() is</span>
        <span style="color:#080;font-style:italic"># called with new input arrays</span>
        line_prof <span style="color:#666">=</span> LineProfiler()
        func_prof <span style="color:#666">=</span> line_prof(func)
        line_prof<span style="color:#666">.</span>add_function(func_to_prof)

        startTime <span style="color:#666">=</span> time<span style="color:#666">.</span>time()
        res <span style="color:#666">=</span> func_prof(<span style="color:#666">*</span>args, <span style="color:#666">**</span>kwargs)
        elapsedTime <span style="color:#666">=</span> time<span style="color:#666">.</span>time() <span style="color:#666">-</span> startTime
        line_prof<span style="color:#666">.</span>dump_stats(<span style="color:#b44">&#34;ll_{}_{}&#34;</span><span style="color:#666">.</span>format(
            str_func_to_profile, <span style="color:#a2f">str</span>(arr_length)))
        time_as_string <span style="color:#666">=</span> <span style="color:#b44">&#39;{:.6f}&#39;</span><span style="color:#666">.</span>format(elapsedTime <span style="color:#666">*</span> <span style="color:#666">1000</span>)
        <span style="color:#a2f;font-weight:bold">return</span> (res, time_as_string)

    <span style="color:#a2f;font-weight:bold">return</span> newfunc</code></pre></div>
<p>Below is a quick introduction to python decorators and how the timeit function had to change to include line profiling.</p>

<h4 id="decorators-are-evaluated-at-runtime">Decorators are evaluated at runtime</h4>

<p>When a python module is loaded or runs, the wrappers are evaluated, as soon as they are encountered. Regardless if the wrapped function is even called anywhere in the module, the decorator processes and returns the new function, as soon as it is given a function to wrape. When the wrapped function is called, it has already been modified, so the function being executed is function that the decorator returned, when it was evaluated earler. To prove that decorators work at wrap-time, not call-time, set breakpoits <code>pdb.set_trace()</code> as below.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">pdb</span>
pdb<span style="color:#666">.</span>set_trace() <span style="color:#080;font-style:italic"># breakpoint 1</span>

<span style="color:#a2f">@timeit</span>
<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">iter_sum</span>(arr1, arr2):
    r_arr1 <span style="color:#666">=</span> arr1[::<span style="color:#666">-</span><span style="color:#666">1</span>]
    r_arr2 <span style="color:#666">=</span> arr2[::<span style="color:#666">-</span><span style="color:#666">1</span>]
    <span style="color:#a2f;font-weight:bold">return</span> iter_sum_helper(r_arr1, r_arr2)[::<span style="color:#666">-</span><span style="color:#666">1</span>]

pdb<span style="color:#666">.</span>set_trace() <span style="color:#080;font-style:italic"># breakpoint 2</span></code></pre></div>
<p>When breakpoint 1 is hit, <code>iter_sum</code> hasn&rsquo;t been defined, so the Python interpreter throws a NameError.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b8860b">$$$$</span> python3 sum_ints_as_arrays.py 
&gt; /home/petr_tik/Coding/misc/misc/sum_ints_profile/sum_ints_as_arrays.py<span style="color:#666">(</span><span style="color:#666">115</span><span style="color:#666">)</span>&lt;module&gt;<span style="color:#666">()</span>
-&gt; @timeit
<span style="color:#666">(</span>Pdb<span style="color:#666">)</span> iter_sum.__name__
*** NameError: name <span style="color:#b44">&#39;iter_sum&#39;</span> is not defined</code></pre></div>
<p><code>(c)ontinuing</code> to breakpoint 2, now <code>iter_sum</code> has been defined and wrapped. <code>newfunc</code> is the name that  came from the closure of <code>timeit</code>. This proves that <code>iter_sum</code> has already been wrapped by timeit, before it&rsquo;s first called.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#666">(</span>Pdb<span style="color:#666">)</span> c
&gt; /home/petr_tik/Coding/misc/misc/sum_ints_profile/sum_ints_as_arrays.py<span style="color:#666">(</span><span style="color:#666">124</span><span style="color:#666">)</span>&lt;module&gt;<span style="color:#666">()</span>
-&gt; @timeit
<span style="color:#666">(</span>Pdb<span style="color:#666">)</span> iter_sum.__name__
<span style="color:#b44">&#39;newfunc&#39;</span></code></pre></div>
<h4 id="closures">Closures</h4>

<p>Decorators in Python rely on the concept of closure. At the time when newfunc is defined inside the <code>timeit</code> function, there are 3 variables available to newfunc: str_func_to_profile, func_to_prof and func (wrapped function) itself. Continuing the same pdb session, freevars inside the code object of <code>iter_sum</code> were examined.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#666">(</span>Pdb<span style="color:#666">)</span> iter_sum.__code__.co_freevars
<span style="color:#666">(</span><span style="color:#b44">&#39;func&#39;</span>, <span style="color:#b44">&#39;func_to_prof&#39;</span>, <span style="color:#b44">&#39;str_func_to_profile&#39;</span><span style="color:#666">)</span></code></pre></div>
<h4 id="adding-line-profiling-to-the-decorator">Adding line-profiling to the decorator</h4>

<p>Using the above and some <a href="https://docs.python.org/3/library/inspect.html"><code>inspect</code></a> hackery, we access the code object of func using  <code>__code__</code>. <code>co_names</code> returns a tuple of names of local variables. Both input funcs - <code>iter_sum</code> or <code>recur_sum</code> only have 1 local variable - its helper function. <code>iter_sum_helper</code> and <code>recur_sum_helper</code> are above this wrapper function in the source code. This guarantees that they will be found when <code>globals</code> is called inside the decorator. Using the string as the key, we retrieve the function object from the globals() dictionary.</p>

<p>Originally, I made a mistake by instantiating the <code>LineProfiler</code> class inside <code>timeit</code>, but before <code>newfunc</code> is defined. This made the same instance of the <code>LineProfiler</code> object availabe to all calls of <code>iter_sum</code> or <code>recur_sum</code> respectively. This would append profiling results into the same file, which was later dumped under a new name. Profiling data for <code>recur_sum_919</code> included the profiling data for all previous runs, which made it incorrect. Instead, each time a function is called, a new instance of the <code>LineProfiler</code> is created, when the input func (<code>iter_sum</code> or <code>recur_sum</code>) is called.</p>

<p>Overall running times are still collected and returned and they are expected to increase with the overhead of line profiling. The line profiler dumps stats into a file called by its function name and array length. The result and elapsed time are returned, used by <code>profile_run</code> to collect and plot time for each function call.</p>

<h2 id="results">Results</h2>

<h3 id="plot">Plot</h3>

<p><img src="{attach}images/plot_sum_ints_profiler.png" alt="Photo" /></p>

<p>In the graph, green is still recursive, red is iterative times. There are several notables differences - times are higher overall - profiling has a noticeable overhead. The difference between iterative and recursive is still present and the shape of ups/downs is similar in both lines . There is a huge spike for the recursive solution when the input arrays are of size 907. This makes it easy to investigate function calls.</p>

<h3 id="reading-the-cprofile-dump">Reading the cProfile dump</h3>

<h4 id="read-function">Read function</h4>

<p>All instances of cProfile for each array length <code>dump_stats</code> into plaintext files recur_{arr<em>length} or iter</em>{arr_length}. <code>read_dump.py</code> is defined to print the dump to terminal to investigate, grep and read through it.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">pstats</span>
<span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">sys</span>


<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">main</span>():
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#a2f">len</span>(sys<span style="color:#666">.</span>argv) <span style="color:#666">!=</span> <span style="color:#666">2</span>:
        <span style="color:#a2f;font-weight:bold">print</span>(<span style="color:#b44">&#34;Supply a filename&#34;</span>)
        <span style="color:#a2f;font-weight:bold">return</span>
    fname <span style="color:#666">=</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">1</span>]

    stats <span style="color:#666">=</span> pstats<span style="color:#666">.</span>Stats(fname)
    stats<span style="color:#666">.</span>sort_stats(<span style="color:#b44">&#34;time&#34;</span>)<span style="color:#666">.</span>print_stats(<span style="color:#666">1.0</span>)

<span style="color:#a2f;font-weight:bold">if</span> __name__ <span style="color:#666">==</span> <span style="color:#b44">&#34;__main__&#34;</span>:
    main()</code></pre></div>
<h4 id="results-1">Results</h4>

<p>Using this script, we examine the dumps of recursive calls with arrays of lengths 917 and 918 (before, during and after the peak).</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b8860b">$$$$</span> ./read_dump.py recur_917 | grep seconds
         <span style="color:#666">5542</span> <span style="color:#a2f;font-weight:bold">function</span> calls <span style="color:#666">(</span><span style="color:#666">4625</span> primitive calls<span style="color:#666">)</span> in <span style="color:#666">0</span>.011 seconds
<span style="color:#b8860b">$$$$</span> ./read_dump.py recur_918 | grep seconds
         <span style="color:#666">5548</span> <span style="color:#a2f;font-weight:bold">function</span> calls <span style="color:#666">(</span><span style="color:#666">4630</span> primitive calls<span style="color:#666">)</span> in <span style="color:#666">0</span>.039 seconds
<span style="color:#b8860b">$$$$</span> ./read_dump.py recur_919 | grep seconds
         <span style="color:#666">5554</span> <span style="color:#a2f;font-weight:bold">function</span> calls <span style="color:#666">(</span><span style="color:#666">4635</span> primitive calls<span style="color:#666">)</span> in <span style="color:#666">0</span>.011 seconds</code></pre></div>
<p>At the peak, the number of function calls increases by 5, but the execution time more than triples.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">petr_tik@merluza:~/Coding/misc/misc/sum_ints_profile$ ./read_dump.py recur_917 <span style="color:#666">&amp;&amp;</span> ./read_dump.py recur_918 <span style="color:#666">&amp;&amp;</span> ./read_dump.py recur_919
Sun Jul <span style="color:#666">23</span> <span style="color:#666">19</span>:18:39 <span style="color:#666">2017</span>    recur_917
         <span style="color:#666">5542</span> <span style="color:#a2f;font-weight:bold">function</span> calls <span style="color:#666">(</span><span style="color:#666">4625</span> primitive calls<span style="color:#666">)</span> in <span style="color:#666">0</span>.011 seconds
   ncalls  tottime  percall  cumtime  percall filename:lineno<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">function</span><span style="color:#666">)</span>
    <span style="color:#666">918</span>/1    <span style="color:#666">0</span>.010    <span style="color:#666">0</span>.000    <span style="color:#666">0</span>.011    <span style="color:#666">0</span>.011 sum_ints_as_arrays.py:52<span style="color:#666">(</span>recur_sum_helper<span style="color:#666">)</span>

Sun Jul <span style="color:#666">23</span> <span style="color:#666">19</span>:18:39 <span style="color:#666">2017</span>    recur_918
         <span style="color:#666">5548</span> <span style="color:#a2f;font-weight:bold">function</span> calls <span style="color:#666">(</span><span style="color:#666">4630</span> primitive calls<span style="color:#666">)</span> in <span style="color:#666">0</span>.039 seconds
   ncalls  tottime  percall  cumtime  percall filename:lineno<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">function</span><span style="color:#666">)</span>
    <span style="color:#666">919</span>/1    <span style="color:#666">0</span>.038    <span style="color:#666">0</span>.000    <span style="color:#666">0</span>.038    <span style="color:#666">0</span>.038 sum_ints_as_arrays.py:52<span style="color:#666">(</span>recur_sum_helper<span style="color:#666">)</span>

Sun Jul <span style="color:#666">23</span> <span style="color:#666">19</span>:18:39 <span style="color:#666">2017</span>    recur_919
         <span style="color:#666">5554</span> <span style="color:#a2f;font-weight:bold">function</span> calls <span style="color:#666">(</span><span style="color:#666">4635</span> primitive calls<span style="color:#666">)</span> in <span style="color:#666">0</span>.011 seconds
   ncalls  tottime  percall  cumtime  percall filename:lineno<span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">function</span><span style="color:#666">)</span>
    <span style="color:#666">920</span>/1    <span style="color:#666">0</span>.010    <span style="color:#666">0</span>.000    <span style="color:#666">0</span>.011    <span style="color:#666">0</span>.011 sum_ints_as_arrays.py:52<span style="color:#666">(</span>recur_sum_helper<span style="color:#666">)</span></code></pre></div>
<p>In all three (and we can assume other) instances of <code>recur_sum</code>, nearly 100% of time is spent on recursive calls of <code>recur_sum_helper</code>. We will need to use line_profiling to get more detail about the increase in execution times.</p>

<h3 id="reading-line-profiling-dump">Reading line profiling dump</h3>

<h4 id="read-function-1">Read function</h4>

<p>The line_profiler module has separate function for loading stats and showing text of the stats object. For serialisation, the line profiler module uses the builtin pickle module, which has wider coverage and better support.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic">#! /usr/bin/env python3</span>

<span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">sys</span>

<span style="color:#a2f;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">line_profiler</span> <span style="color:#a2f;font-weight:bold">import</span> load_stats, show_text

<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">main</span>():
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#a2f">len</span>(sys<span style="color:#666">.</span>argv) <span style="color:#666">!=</span> <span style="color:#666">2</span>:
        <span style="color:#a2f;font-weight:bold">print</span>(<span style="color:#b44">&#34;Supply a filename&#34;</span>)
        <span style="color:#a2f;font-weight:bold">return</span>
    fname <span style="color:#666">=</span> sys<span style="color:#666">.</span>argv[<span style="color:#666">1</span>]

    stats <span style="color:#666">=</span> load_stats(fname)
    show_text(stats<span style="color:#666">.</span>timings, stats<span style="color:#666">.</span>unit)

<span style="color:#a2f;font-weight:bold">if</span> __name__ <span style="color:#666">==</span> <span style="color:#b44">&#34;__main__&#34;</span>:
    main()</code></pre></div>
<h4 id="results-2">Results</h4>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#b8860b">$$$$</span> ./read_ll.py ll_recur_sum_helper_917
Timer unit: 1e-06 s

Total time: <span style="color:#666">0</span>.006587 s
File: sum_ints_as_arrays.py
Function: recur_sum_helper at line <span style="color:#666">52</span>

Line <span style="color:#080;font-style:italic">#      Hits         Time  Per Hit   % Time  Line Contents</span>
<span style="color:#666">==============================================================</span>
    <span style="color:#666">52</span>                                           def recur_sum_helper<span style="color:#666">(</span>arr1, arr2, <span style="color:#b8860b">idx</span><span style="color:#666">=</span><span style="color:#666">0</span>, <span style="color:#b8860b">res</span><span style="color:#666">=[]</span>, <span style="color:#b8860b">carry</span><span style="color:#666">=</span><span style="color:#666">0</span><span style="color:#666">)</span>:
    <span style="color:#666">53</span>       <span style="color:#666">918</span>          <span style="color:#666">481</span>      <span style="color:#666">0</span>.5      <span style="color:#666">7</span>.3      <span style="color:#a2f;font-weight:bold">if</span> not res:
    <span style="color:#666">54</span>         <span style="color:#666">1</span>            <span style="color:#666">2</span>      <span style="color:#666">2</span>.0      <span style="color:#666">0</span>.0          <span style="color:#b8860b">res</span> <span style="color:#666">=</span> list<span style="color:#666">()</span>
    <span style="color:#666">55</span>       <span style="color:#666">918</span>          <span style="color:#666">926</span>      <span style="color:#666">1</span>.0     <span style="color:#666">14</span>.1      <span style="color:#a2f;font-weight:bold">if</span> idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr1<span style="color:#666">)</span> and idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr2<span style="color:#666">)</span>:
    <span style="color:#666">56</span>         <span style="color:#666">1</span>            <span style="color:#666">1</span>      <span style="color:#666">1</span>.0      <span style="color:#666">0</span>.0          <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b8860b">carry</span> <span style="color:#666">==</span> <span style="color:#666">1</span>:
    <span style="color:#666">57</span>         <span style="color:#666">1</span>            <span style="color:#666">1</span>      <span style="color:#666">1</span>.0      <span style="color:#666">0</span>.0              res.append<span style="color:#666">(</span><span style="color:#666">1</span><span style="color:#666">)</span>
    <span style="color:#666">58</span>         <span style="color:#666">1</span>            <span style="color:#666">1</span>      <span style="color:#666">1</span>.0      <span style="color:#666">0</span>.0          <span style="color:#a2f;font-weight:bold">return</span> res
    <span style="color:#666">59</span>       <span style="color:#666">917</span>          <span style="color:#666">797</span>      <span style="color:#666">0</span>.9     <span style="color:#666">12</span>.1      <span style="color:#a2f;font-weight:bold">if</span> idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr1<span style="color:#666">)</span>:
    <span style="color:#666">60</span>                                                   carry, <span style="color:#b8860b">item_to_add</span> <span style="color:#666">=</span> divmod<span style="color:#666">(</span>carry + arr2<span style="color:#666">[</span>idx<span style="color:#666">]</span>, <span style="color:#666">10</span><span style="color:#666">)</span>
    <span style="color:#666">61</span>                                                   res.append<span style="color:#666">(</span>item_to_add<span style="color:#666">)</span>
    <span style="color:#666">62</span>                                                   <span style="color:#b8860b">idx</span> <span style="color:#666">+=</span> <span style="color:#666">1</span>
    <span style="color:#666">63</span>                                                   <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>arr1, arr2, idx, res, carry<span style="color:#666">)</span>
    <span style="color:#666">64</span>       <span style="color:#666">917</span>          <span style="color:#666">782</span>      <span style="color:#666">0</span>.9     <span style="color:#666">11</span>.9      <span style="color:#a2f;font-weight:bold">if</span> idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr2<span style="color:#666">)</span>:
    <span style="color:#666">65</span>                                                   carry, <span style="color:#b8860b">item_to_add</span> <span style="color:#666">=</span> divmod<span style="color:#666">(</span>carry + arr1<span style="color:#666">[</span>idx<span style="color:#666">]</span>, <span style="color:#666">10</span><span style="color:#666">)</span>
    <span style="color:#666">66</span>                                                   res.append<span style="color:#666">(</span>item_to_add<span style="color:#666">)</span>
    <span style="color:#666">67</span>                                                   <span style="color:#b8860b">idx</span> <span style="color:#666">+=</span> <span style="color:#666">1</span>
    <span style="color:#666">68</span>                                                   <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>arr1, arr2, idx, res, carry<span style="color:#666">)</span>
    <span style="color:#666">69</span>                                           
    <span style="color:#666">70</span>       <span style="color:#666">917</span>         <span style="color:#666">1109</span>      <span style="color:#666">1</span>.2     <span style="color:#666">16</span>.8      carry, <span style="color:#b8860b">item_to_add</span> <span style="color:#666">=</span> divmod<span style="color:#666">(</span>carry + arr1<span style="color:#666">[</span>idx<span style="color:#666">]</span> + arr2<span style="color:#666">[</span>idx<span style="color:#666">]</span>, <span style="color:#666">10</span><span style="color:#666">)</span>
    <span style="color:#666">71</span>       <span style="color:#666">917</span>          <span style="color:#666">842</span>      <span style="color:#666">0</span>.9     <span style="color:#666">12</span>.8      res.append<span style="color:#666">(</span>item_to_add<span style="color:#666">)</span>
    <span style="color:#666">72</span>       <span style="color:#666">917</span>          <span style="color:#666">564</span>      <span style="color:#666">0</span>.6      <span style="color:#666">8</span>.6      <span style="color:#b8860b">idx</span> <span style="color:#666">+=</span> <span style="color:#666">1</span>
    <span style="color:#666">73</span>       <span style="color:#666">917</span>         <span style="color:#666">1081</span>      <span style="color:#666">1</span>.2     <span style="color:#666">16</span>.4      <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>arr1, arr2, idx, res, carry<span style="color:#666">)</span>

Total time: <span style="color:#666">0</span>.010676 s
File: sum_ints_as_arrays.py
Function: recur_sum at line <span style="color:#666">119</span>

Line <span style="color:#080;font-style:italic">#      Hits         Time  Per Hit   % Time  Line Contents</span>
<span style="color:#666">==============================================================</span>
   <span style="color:#666">119</span>                                           @timeit
   <span style="color:#666">120</span>                                           def recur_sum<span style="color:#666">(</span>arr1, arr2<span style="color:#666">)</span>:
   <span style="color:#666">121</span>         <span style="color:#666">1</span>           <span style="color:#666">11</span>     <span style="color:#666">11</span>.0      <span style="color:#666">0</span>.1      <span style="color:#b8860b">r_arr1</span> <span style="color:#666">=</span> arr1<span style="color:#666">[</span>::-1<span style="color:#666">]</span>
   <span style="color:#666">122</span>         <span style="color:#666">1</span>            <span style="color:#666">7</span>      <span style="color:#666">7</span>.0      <span style="color:#666">0</span>.1      <span style="color:#b8860b">r_arr2</span> <span style="color:#666">=</span> arr2<span style="color:#666">[</span>::-1<span style="color:#666">]</span>
   <span style="color:#666">123</span>         <span style="color:#666">1</span>        <span style="color:#666">10658</span>  <span style="color:#666">10658</span>.0     <span style="color:#666">99</span>.8      <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>r_arr1, r_arr2<span style="color:#666">)[</span>::-1<span style="color:#666">]</span>

<span style="color:#b8860b">$$$$</span> ./read_ll.py ll_recur_sum_helper_918
Timer unit: 1e-06 s

Total time: <span style="color:#666">0</span>.034118 s
File: sum_ints_as_arrays.py
Function: recur_sum_helper at line <span style="color:#666">52</span>

Line <span style="color:#080;font-style:italic">#      Hits         Time  Per Hit   % Time  Line Contents</span>
<span style="color:#666">==============================================================</span>
    <span style="color:#666">52</span>                                           def recur_sum_helper<span style="color:#666">(</span>arr1, arr2, <span style="color:#b8860b">idx</span><span style="color:#666">=</span><span style="color:#666">0</span>, <span style="color:#b8860b">res</span><span style="color:#666">=[]</span>, <span style="color:#b8860b">carry</span><span style="color:#666">=</span><span style="color:#666">0</span><span style="color:#666">)</span>:
    <span style="color:#666">53</span>       <span style="color:#666">919</span>          <span style="color:#666">472</span>      <span style="color:#666">0</span>.5      <span style="color:#666">1</span>.4      <span style="color:#a2f;font-weight:bold">if</span> not res:
    <span style="color:#666">54</span>         <span style="color:#666">1</span>            <span style="color:#666">3</span>      <span style="color:#666">3</span>.0      <span style="color:#666">0</span>.0          <span style="color:#b8860b">res</span> <span style="color:#666">=</span> list<span style="color:#666">()</span>
    <span style="color:#666">55</span>       <span style="color:#666">919</span>          <span style="color:#666">892</span>      <span style="color:#666">1</span>.0      <span style="color:#666">2</span>.6      <span style="color:#a2f;font-weight:bold">if</span> idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr1<span style="color:#666">)</span> and idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr2<span style="color:#666">)</span>:
    <span style="color:#666">56</span>         <span style="color:#666">1</span>            <span style="color:#666">0</span>      <span style="color:#666">0</span>.0      <span style="color:#666">0</span>.0          <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b8860b">carry</span> <span style="color:#666">==</span> <span style="color:#666">1</span>:
    <span style="color:#666">57</span>         <span style="color:#666">1</span>            <span style="color:#666">1</span>      <span style="color:#666">1</span>.0      <span style="color:#666">0</span>.0              res.append<span style="color:#666">(</span><span style="color:#666">1</span><span style="color:#666">)</span>
    <span style="color:#666">58</span>         <span style="color:#666">1</span>            <span style="color:#666">1</span>      <span style="color:#666">1</span>.0      <span style="color:#666">0</span>.0          <span style="color:#a2f;font-weight:bold">return</span> res
    <span style="color:#666">59</span>       <span style="color:#666">918</span>          <span style="color:#666">763</span>      <span style="color:#666">0</span>.8      <span style="color:#666">2</span>.2      <span style="color:#a2f;font-weight:bold">if</span> idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr1<span style="color:#666">)</span>:
    <span style="color:#666">60</span>                                                   carry, <span style="color:#b8860b">item_to_add</span> <span style="color:#666">=</span> divmod<span style="color:#666">(</span>carry + arr2<span style="color:#666">[</span>idx<span style="color:#666">]</span>, <span style="color:#666">10</span><span style="color:#666">)</span>
    <span style="color:#666">61</span>                                                   res.append<span style="color:#666">(</span>item_to_add<span style="color:#666">)</span>
    <span style="color:#666">62</span>                                                   <span style="color:#b8860b">idx</span> <span style="color:#666">+=</span> <span style="color:#666">1</span>
    <span style="color:#666">63</span>                                                   <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>arr1, arr2, idx, res, carry<span style="color:#666">)</span>
    <span style="color:#666">64</span>       <span style="color:#666">918</span>          <span style="color:#666">776</span>      <span style="color:#666">0</span>.8      <span style="color:#666">2</span>.3      <span style="color:#a2f;font-weight:bold">if</span> idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr2<span style="color:#666">)</span>:
    <span style="color:#666">65</span>                                                   carry, <span style="color:#b8860b">item_to_add</span> <span style="color:#666">=</span> divmod<span style="color:#666">(</span>carry + arr1<span style="color:#666">[</span>idx<span style="color:#666">]</span>, <span style="color:#666">10</span><span style="color:#666">)</span>
    <span style="color:#666">66</span>                                                   res.append<span style="color:#666">(</span>item_to_add<span style="color:#666">)</span>
    <span style="color:#666">67</span>                                                   <span style="color:#b8860b">idx</span> <span style="color:#666">+=</span> <span style="color:#666">1</span>
    <span style="color:#666">68</span>                                                   <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>arr1, arr2, idx, res, carry<span style="color:#666">)</span>
    <span style="color:#666">69</span>                                           
    <span style="color:#666">70</span>       <span style="color:#666">918</span>         <span style="color:#666">1062</span>      <span style="color:#666">1</span>.2      <span style="color:#666">3</span>.1      carry, <span style="color:#b8860b">item_to_add</span> <span style="color:#666">=</span> divmod<span style="color:#666">(</span>carry + arr1<span style="color:#666">[</span>idx<span style="color:#666">]</span> + arr2<span style="color:#666">[</span>idx<span style="color:#666">]</span>, <span style="color:#666">10</span><span style="color:#666">)</span>
    <span style="color:#666">71</span>       <span style="color:#666">918</span>          <span style="color:#666">814</span>      <span style="color:#666">0</span>.9      <span style="color:#666">2</span>.4      res.append<span style="color:#666">(</span>item_to_add<span style="color:#666">)</span>
    <span style="color:#666">72</span>       <span style="color:#666">918</span>          <span style="color:#666">542</span>      <span style="color:#666">0</span>.6      <span style="color:#666">1</span>.6      <span style="color:#b8860b">idx</span> <span style="color:#666">+=</span> <span style="color:#666">1</span>
    <span style="color:#666">73</span>       <span style="color:#666">918</span>        <span style="color:#666">28792</span>     <span style="color:#666">31</span>.4     <span style="color:#666">84</span>.4      <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>arr1, arr2, idx, res, carry<span style="color:#666">)</span>

Total time: <span style="color:#666">0</span>.038265 s
File: sum_ints_as_arrays.py
Function: recur_sum at line <span style="color:#666">119</span>

Line <span style="color:#080;font-style:italic">#      Hits         Time  Per Hit   % Time  Line Contents</span>
<span style="color:#666">==============================================================</span>
   <span style="color:#666">119</span>                                           @timeit
   <span style="color:#666">120</span>                                           def recur_sum<span style="color:#666">(</span>arr1, arr2<span style="color:#666">)</span>:
   <span style="color:#666">121</span>         <span style="color:#666">1</span>           <span style="color:#666">11</span>     <span style="color:#666">11</span>.0      <span style="color:#666">0</span>.0      <span style="color:#b8860b">r_arr1</span> <span style="color:#666">=</span> arr1<span style="color:#666">[</span>::-1<span style="color:#666">]</span>
   <span style="color:#666">122</span>         <span style="color:#666">1</span>            <span style="color:#666">6</span>      <span style="color:#666">6</span>.0      <span style="color:#666">0</span>.0      <span style="color:#b8860b">r_arr2</span> <span style="color:#666">=</span> arr2<span style="color:#666">[</span>::-1<span style="color:#666">]</span>
   <span style="color:#666">123</span>         <span style="color:#666">1</span>        <span style="color:#666">38248</span>  <span style="color:#666">38248</span>.0    <span style="color:#666">100</span>.0      <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>r_arr1, r_arr2<span style="color:#666">)[</span>::-1<span style="color:#666">]</span>

<span style="color:#b8860b">$$$$</span> ./read_ll.py ll_recur_sum_helper_919
Timer unit: 1e-06 s

Total time: <span style="color:#666">0</span>.006544 s
File: sum_ints_as_arrays.py
Function: recur_sum_helper at line <span style="color:#666">52</span>

Line <span style="color:#080;font-style:italic">#      Hits         Time  Per Hit   % Time  Line Contents</span>
<span style="color:#666">==============================================================</span>
    <span style="color:#666">52</span>                                           def recur_sum_helper<span style="color:#666">(</span>arr1, arr2, <span style="color:#b8860b">idx</span><span style="color:#666">=</span><span style="color:#666">0</span>, <span style="color:#b8860b">res</span><span style="color:#666">=[]</span>, <span style="color:#b8860b">carry</span><span style="color:#666">=</span><span style="color:#666">0</span><span style="color:#666">)</span>:
    <span style="color:#666">53</span>       <span style="color:#666">920</span>          <span style="color:#666">495</span>      <span style="color:#666">0</span>.5      <span style="color:#666">7</span>.6      <span style="color:#a2f;font-weight:bold">if</span> not res:
    <span style="color:#666">54</span>         <span style="color:#666">1</span>            <span style="color:#666">2</span>      <span style="color:#666">2</span>.0      <span style="color:#666">0</span>.0          <span style="color:#b8860b">res</span> <span style="color:#666">=</span> list<span style="color:#666">()</span>
    <span style="color:#666">55</span>       <span style="color:#666">920</span>          <span style="color:#666">936</span>      <span style="color:#666">1</span>.0     <span style="color:#666">14</span>.3      <span style="color:#a2f;font-weight:bold">if</span> idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr1<span style="color:#666">)</span> and idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr2<span style="color:#666">)</span>:
    <span style="color:#666">56</span>         <span style="color:#666">1</span>            <span style="color:#666">0</span>      <span style="color:#666">0</span>.0      <span style="color:#666">0</span>.0          <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b8860b">carry</span> <span style="color:#666">==</span> <span style="color:#666">1</span>:
    <span style="color:#666">57</span>         <span style="color:#666">1</span>            <span style="color:#666">1</span>      <span style="color:#666">1</span>.0      <span style="color:#666">0</span>.0              res.append<span style="color:#666">(</span><span style="color:#666">1</span><span style="color:#666">)</span>
    <span style="color:#666">58</span>         <span style="color:#666">1</span>            <span style="color:#666">0</span>      <span style="color:#666">0</span>.0      <span style="color:#666">0</span>.0          <span style="color:#a2f;font-weight:bold">return</span> res
    <span style="color:#666">59</span>       <span style="color:#666">919</span>          <span style="color:#666">788</span>      <span style="color:#666">0</span>.9     <span style="color:#666">12</span>.0      <span style="color:#a2f;font-weight:bold">if</span> idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr1<span style="color:#666">)</span>:
    <span style="color:#666">60</span>                                                   carry, <span style="color:#b8860b">item_to_add</span> <span style="color:#666">=</span> divmod<span style="color:#666">(</span>carry + arr2<span style="color:#666">[</span>idx<span style="color:#666">]</span>, <span style="color:#666">10</span><span style="color:#666">)</span>
    <span style="color:#666">61</span>                                                   res.append<span style="color:#666">(</span>item_to_add<span style="color:#666">)</span>
    <span style="color:#666">62</span>                                                   <span style="color:#b8860b">idx</span> <span style="color:#666">+=</span> <span style="color:#666">1</span>
    <span style="color:#666">63</span>                                                   <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>arr1, arr2, idx, res, carry<span style="color:#666">)</span>
    <span style="color:#666">64</span>       <span style="color:#666">919</span>          <span style="color:#666">785</span>      <span style="color:#666">0</span>.9     <span style="color:#666">12</span>.0      <span style="color:#a2f;font-weight:bold">if</span> idx &gt;<span style="color:#666">=</span> len<span style="color:#666">(</span>arr2<span style="color:#666">)</span>:
    <span style="color:#666">65</span>                                                   carry, <span style="color:#b8860b">item_to_add</span> <span style="color:#666">=</span> divmod<span style="color:#666">(</span>carry + arr1<span style="color:#666">[</span>idx<span style="color:#666">]</span>, <span style="color:#666">10</span><span style="color:#666">)</span>
    <span style="color:#666">66</span>                                                   res.append<span style="color:#666">(</span>item_to_add<span style="color:#666">)</span>
    <span style="color:#666">67</span>                                                   <span style="color:#b8860b">idx</span> <span style="color:#666">+=</span> <span style="color:#666">1</span>
    <span style="color:#666">68</span>                                                   <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>arr1, arr2, idx, res, carry<span style="color:#666">)</span>
    <span style="color:#666">69</span>                                           
    <span style="color:#666">70</span>       <span style="color:#666">919</span>         <span style="color:#666">1107</span>      <span style="color:#666">1</span>.2     <span style="color:#666">16</span>.9      carry, <span style="color:#b8860b">item_to_add</span> <span style="color:#666">=</span> divmod<span style="color:#666">(</span>carry + arr1<span style="color:#666">[</span>idx<span style="color:#666">]</span> + arr2<span style="color:#666">[</span>idx<span style="color:#666">]</span>, <span style="color:#666">10</span><span style="color:#666">)</span>
    <span style="color:#666">71</span>       <span style="color:#666">919</span>          <span style="color:#666">827</span>      <span style="color:#666">0</span>.9     <span style="color:#666">12</span>.6      res.append<span style="color:#666">(</span>item_to_add<span style="color:#666">)</span>
    <span style="color:#666">72</span>       <span style="color:#666">919</span>          <span style="color:#666">532</span>      <span style="color:#666">0</span>.6      <span style="color:#666">8</span>.1      <span style="color:#b8860b">idx</span> <span style="color:#666">+=</span> <span style="color:#666">1</span>
    <span style="color:#666">73</span>       <span style="color:#666">919</span>         <span style="color:#666">1071</span>      <span style="color:#666">1</span>.2     <span style="color:#666">16</span>.4      <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>arr1, arr2, idx, res, carry<span style="color:#666">)</span>

Total time: <span style="color:#666">0</span>.010754 s
File: sum_ints_as_arrays.py
Function: recur_sum at line <span style="color:#666">119</span>

Line <span style="color:#080;font-style:italic">#      Hits         Time  Per Hit   % Time  Line Contents</span>
<span style="color:#666">==============================================================</span>
   <span style="color:#666">119</span>                                           @timeit
   <span style="color:#666">120</span>                                           def recur_sum<span style="color:#666">(</span>arr1, arr2<span style="color:#666">)</span>:
   <span style="color:#666">121</span>         <span style="color:#666">1</span>           <span style="color:#666">11</span>     <span style="color:#666">11</span>.0      <span style="color:#666">0</span>.1      <span style="color:#b8860b">r_arr1</span> <span style="color:#666">=</span> arr1<span style="color:#666">[</span>::-1<span style="color:#666">]</span>
   <span style="color:#666">122</span>         <span style="color:#666">1</span>            <span style="color:#666">6</span>      <span style="color:#666">6</span>.0      <span style="color:#666">0</span>.1      <span style="color:#b8860b">r_arr2</span> <span style="color:#666">=</span> arr2<span style="color:#666">[</span>::-1<span style="color:#666">]</span>
   <span style="color:#666">123</span>         <span style="color:#666">1</span>        <span style="color:#666">10737</span>  <span style="color:#666">10737</span>.0     <span style="color:#666">99</span>.8      <span style="color:#a2f;font-weight:bold">return</span> recur_sum_helper<span style="color:#666">(</span>r_arr1, r_arr2<span style="color:#666">)[</span>::-1<span style="color:#666">]</span></code></pre></div>
<h2 id="conclusion">Conclusion</h2>

<p>This post showed the use of <code>cProfile</code> and <code>line_profiler</code> modules implemented as wrappers to collect and review profiling information. Decorators, which rely on the concept of closures and runtime code inspection, were explained and used for implementing profiling. The spike in execution times of the recursive solution was found using line_profiling. Given arrays of length 918, the recursive sum function for some unexplained reasons takes 28x more time to run than previous and consequent function calls.</p>

<h2 id="future-work">Future work</h2>

<p>At this point, it&rsquo;s best to implement tracing either inside python interpreter or from outside the process. By tracing and logging each recursively created and executed stack frame inside <code>recur_sum_helper</code>, we can get more information about the slowdown. Another avenue for investigation can be looking into CPython source code. Methods like <code>list.append()</code> might cause reallocation, which would slow down the execution at some stack frames. The line profiling results suggest that would be unlikely, unless they fail to time that.</p>

      
    </div>
    
  </div>
</section>



<section class="section">
  <div class="container has-text-centered">
    <p></p>
    
  </div>
</section>



</body>
</html>

