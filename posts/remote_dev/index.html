<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-us">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title> | Software and puns</title>



<link href="http://petr-tik.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Software and puns" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="http://petr-tik.github.io/">
          <h1 class="title is-4">Software and puns</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/petr-tik'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/petr_tik'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      
      <div class="nav-left"><a class="nav-item" href="/about">
          <h2 class="title is-5">whoami</h2>
        </a></div>
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
    </div>
    
    <h1 class="title"></h1>
    
    <div class="content">
      

<h2 id="remote--rust--development-environment"><span class="org-todo done DONE">DONE</span> Remote (rust) development environment</h2>

<h3 id="picture-this-at-home">Picture this at home</h3>

<p>Imaging you are working on a large Rust project. You have added a new feature,
wrote some tests and kick off the compile and test process. While you wait, you
switch to browsing Reddit. You like using a thin laptop - you can take it
anywhere and fit it into even the smallest bags. Your laptop starts churning
along, it&rsquo;s getting hotter under your hands and you see that Reddit is less
responsive. After several such compilation cycles, you notice that your battery
indicator has one bar left. You only unplugged it an hour ago and now you have
to go charge it again.</p>

<p>I found myself in that situation, when I started working on <a href="https://github.com/tantivy-search/tantivy/">tantivy</a>. During
winter months, using my laptop as an additional heater felt like a useful life
hack. Now that spring has sprung, I prefer to keep it cool. I decided to offload
CPU and RAM-intensive compilation and testing cycle to a remote machine.</p>

<p>This post outlines my system for saving battery and longevity of my laptop by
making someone else&rsquo;s computer suffer.</p>

<p>It&rsquo;s largely inspired by <a href="https://github.com/pzmarzly/cloudy">pzmarzly&rsquo;s cloudy</a> project.</p>

<h3 id="mvp">MVP</h3>

<p>Whenever possible, CPU-heavy compilation will take place on the VPS. All source
code changes will be updated, so at every point both local and VPS version of
the code match. If compilation and testing succeed, the executables are rsync&rsquo;ed
from the VPS to my laptop.</p>

<h3 id="do-you-always-compile-remotely">Do you always compile remotely?</h3>

<p>Obviously, if there is no internet connection and I cannot reach my droplet, it doesn&rsquo;t matter how big the repo is - I can only compile locally.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">is_connected <span style="color:#666">()</span> <span style="color:#666">{</span>
  <span style="color:#a2f">echo</span> <span style="color:#a2f;font-weight:bold">$(</span>nc -z <span style="color:#b8860b">$VPS_IP</span> <span style="color:#666">22</span><span style="color:#a2f;font-weight:bold">)</span>
<span style="color:#666">}</span></code></pre></div>
<p>Depending on the compile times of a given project network latency between the
compile droplet and my laptop might cancel out the time wins. I want to build a
general solution, so I need to decide when to compile locally or offload it
externally.</p>

<p>Using advanced ML algorithms and groundbreaking mathematical methods like linear
regression, I can classify if the compilation time is long enough to justify
offloading it to a VPS.</p>

<p>I use line count as a predictor for compile times that are long enough to be offloaded. Counts the total number of lines in .rs source files.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">is_project_big <span style="color:#666">()</span> <span style="color:#666">{</span>
      <span style="color:#080;font-style:italic"># get a list of directories with interesting rust code - either src or tests
</span><span style="color:#080;font-style:italic"></span>        <span style="color:#b8860b">DIRECTORIES</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span>find . -maxdepth <span style="color:#666">1</span> -type d | grep <span style="color:#b44">&#34;src\|test&#34;</span> | cut -c <span style="color:#666">3</span>-<span style="color:#a2f;font-weight:bold">)</span>;
        <span style="color:#080;font-style:italic"># get the total LoC in any .rs files in these directories
</span><span style="color:#080;font-style:italic"></span>        <span style="color:#b8860b">LOC_IN_RUST_FILES</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span>find <span style="color:#b8860b">$DIRECTORIES</span> -type f -name <span style="color:#b44">&#34;*.rs&#34;</span> | xargs wc -l | tail -1 | cut -d<span style="color:#b44">&#34; &#34;</span> -f3<span style="color:#a2f;font-weight:bold">)</span>;
        <span style="color:#b8860b">THRESHOLD_TO_COMPILE_REMOTELY</span><span style="color:#666">=</span><span style="color:#666">25000</span>;
        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">[</span> <span style="color:#b8860b">$LOC_IN_RUST_FILES</span> -ge <span style="color:#b8860b">$THRESHOLD_TO_COMPILE_REMOTELY</span> <span style="color:#666">]</span>; <span style="color:#a2f;font-weight:bold">then</span>
            <span style="color:#a2f">echo</span> <span style="color:#b44">&#34;true&#34;</span>
        <span style="color:#a2f;font-weight:bold">else</span>
            <span style="color:#a2f">echo</span> <span style="color:#b44">&#34;false&#34;</span>
        <span style="color:#a2f;font-weight:bold">fi</span>
    <span style="color:#666">}</span></code></pre></div>
<p>At the time of writing tantivy has <code>35856</code> lines of Rust code.</p>

<h3 id="what-do-you-need-to-compile-remotely">What do you need to compile remotely?</h3>

<h4 id="local-config">Local config</h4>

<p>Put this in a 