<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Articles, ">

        <link rel="alternate"  href="/feeds/all.atom.xml" type="application/atom+xml" title="Articles Full Atom Feed"/>

        <title>Stracing emacs. Part 3 // Articles // </title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/theme/css/pure.css">
    <link rel="stylesheet" href="/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <div class="cover-img" style="background: none repeat scroll 0% 0% #3D4F5D">
                <div class="cover-body">
                    <header class="header">
                        <hgroup>
                            <h1 class="brand-main"><a href="">Articles</a></h1>
                            <p class="tagline"></p>
                                <p class="social">
                                    <a href="https://github.com/petr-tik">
                                        <i class="fa fa-GitHub fa-3x"></i>
                                    </a>
                                    <a href="https://twitter.com/petr_tik">
                                        <i class="fa fa-Twitter fa-3x"></i>
                                    </a>
                                </p>
                        </hgroup>
                    </header>
                </div>
            </div>
        </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Stracing emacs. Part 3</h1>
                        <p class="post-meta">
                            // under                                 <a class="post-category" href="/tag/linux.html">linux</a>
                                <a class="post-category" href="/tag/tracing.html">tracing</a>
                                <a class="post-category" href="/tag/emacs.html">emacs</a>
                        </p>
                </header>
            </section>
            <h2>emacs syscalls</h2>
<p>The emacs git repo has the source code for the .c files that define wrapper functions for the respective syscalls. This is done to account for different OSes providing different kernel specification. It might be helpful to look at the source code for the different syscalls.</p>
<h2>Top 10 by errors</h2>
<p>I won't repeat the same syscalls I investigated in previous parts, just the new ones. </p>
<div class="highlight"><pre><span></span><span class="nv">$$$$</span> tail -n <span class="m">67</span> emacs_strace_output <span class="p">|</span> head -n <span class="m">65</span> <span class="p">|</span> awk -F<span class="s2">&quot; &quot;</span> <span class="s1">&#39; { print $5, $6 }&#39;</span> <span class="p">|</span> grep ^<span class="o">[</span><span class="m">0</span>-9<span class="o">]</span> <span class="p">|</span> sort -nrk1
<span class="m">17979</span> open
<span class="m">3609</span> recvmsg
<span class="m">1446</span> faccessat
<span class="m">1143</span> readlinkat
<span class="m">119</span> stat
<span class="m">117</span> access
<span class="m">4</span> connect
<span class="m">2</span> statfs
<span class="m">2</span> rt_sigreturn
<span class="m">2</span> recvfrom
<span class="m">2</span> getxattr
<span class="m">1</span> wait4
<span class="m">1</span> <span class="nb">read</span>
</pre></div>


<ol>
<li>Take the summary table from the bottom of the output file. </li>
<li>Discard the bottom lines </li>
<li>take the last 2 columns (split by whitespace), which should give us the number of errors and the syscall. If no errors are present, it will just output the syscall name</li>
<li>Leave only the lines starting with a number i.e. those with a number of errors &gt; 0</li>
<li>numerically sort (in reverse order) by the values in the first column </li>
</ol>
<h2>faccessat</h2>
<div class="highlight"><pre><span></span>grep <span class="s2">&quot;^faccessat&quot;</span> emacs_strace_output <span class="p">|</span> grep -v <span class="s2">&quot; = 0&quot;</span>
</pre></div>


<h3>Sys call</h3>
<p>Checks if the user has permission to access the file.</p>
<p>Input:
  * int for directory file descriptor. The <code>AT_FDCWD</code> macro used to indicate current working directory. You can set another directory file descriptor and the pathname will be evaluated with respect to a different directory.
  * pathname
  * mode of access - F_OK checks for existence, R_OK, W_OK and X_OK for reading, writing and executing respectively.</p>
<h3>Errors</h3>
<p>Files that couldn't be accessed, because they don't exist. </p>
<div class="highlight"><pre><span></span>faccessat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/highlight-indentation-20161012.209.signed&quot;</span>, F_OK<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
faccessat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/ido-ubiquitous-20140526.1306.signed&quot;</span>, F_OK<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
faccessat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/irony-20170313.1437.signed&quot;</span>, F_OK<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
faccessat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/ivy-20170202.223.signed&quot;</span>, F_OK<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
faccessat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/json-mode-20160803.1606.signed&quot;</span>, F_OK<span class="o">)</span> <span class="o">=</span> -1 ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
.
.
.
<span class="nv">$$$$</span> grep <span class="s2">&quot;^faccessat&quot;</span> emacs_strace_output <span class="p">|</span> grep -v <span class="s2">&quot; = 0&quot;</span> <span class="p">|</span> grep -c <span class="s2">&quot;.signed&quot;</span>
<span class="m">82</span>
<span class="nv">$$$$</span> tree ~/.emacs.d/elpa/ <span class="p">|</span> grep -c <span class="s2">&quot;.signed&quot;</span>
<span class="m">6</span>
<span class="nv">$$$$</span> grep <span class="s2">&quot;^faccessat&quot;</span> emacs_strace_output <span class="p">|</span> grep -c <span class="s2">&quot;W_OK&quot;</span>
<span class="m">8</span>
<span class="nv">$$$$</span> grep <span class="s2">&quot;^faccessat&quot;</span> emacs_strace_output <span class="p">|</span> grep -c <span class="s2">&quot;W_OK) = 0&quot;</span>
<span class="m">0</span>
<span class="nv">$$$$</span> grep <span class="s2">&quot;^faccessat&quot;</span> emacs_strace_output <span class="p">|</span> grep -v <span class="s2">&quot; = 0&quot;</span> <span class="p">|</span> grep -c <span class="s2">&quot;R_OK&quot;</span>
<span class="m">111</span>
<span class="nv">$$$$</span> grep <span class="s2">&quot;^faccessat&quot;</span> emacs_strace_output <span class="p">|</span> grep -v <span class="s2">&quot; = 0&quot;</span> <span class="p">|</span> grep -c <span class="s2">&quot;X_OK&quot;</span>
<span class="m">76</span>
</pre></div>


<p>111 files couldn't be read by emacs. </p>
<p>82 .signed files couldn't be accessed and only 6 .signed files are in the directory (recursively checking). </p>
<p>Write access:
All 8 files emacs wants to write to can be accessed. </p>
<p>Read access</p>
<h2>readlinkat</h2>
<h3>Sys call</h3>
<p>Follows and reads a value from a symbolic link into a given buffer. Successful calls return the number of bytes written to buffer, errors return -1.</p>
<h3>Source</h3>
<p>From the <a href="https://github.com/emacs-mirror/emacs/blob/master/lib/readlinkat.c">emacs Github Mirror</a></p>
<h3>Errors</h3>
<div class="highlight"><pre><span></span><span class="nv">$$$$</span> grep <span class="s2">&quot;^readlinkat&quot;</span> emacs_strace_output <span class="p">|</span> grep -v <span class="s2">&quot; = 0&quot;</span> <span class="p">|</span> awk -F <span class="s1">&#39;-1 | \\(&#39;</span> <span class="s1">&#39;{ print $2}&#39;</span> <span class="p">|</span> sort -n <span class="p">|</span> uniq -c
      <span class="m">5</span> 
   <span class="m">1139</span> EINVAL
      <span class="m">4</span> ENOENT
</pre></div>


<p>ENOENT - is when the given file doesn't exist. 
EINVAL - either the bufsiz isn't positive or the given pathname isn't a symbolic link</p>
<div class="highlight"><pre><span></span><span class="nv">$$$$</span> grep <span class="s2">&quot;^readlinkat&quot;</span> emacs_strace_output <span class="p">|</span> grep -v <span class="s2">&quot; = 0&quot;</span> <span class="p">|</span> gawk -F<span class="s2">&quot;, &quot;</span> <span class="s1">&#39; { print $3 }&#39;</span> <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort -nk1
.
.
.
      <span class="m">1</span> 0x7fffe375fc80
      <span class="m">1</span> 0x7fffe375fcf0
      <span class="m">1</span> 0x7fffe375fd70
      <span class="m">1</span> 0x7fffe375fd90
      <span class="m">1</span> 0x7fffe375fdd0
      <span class="m">1</span> 0x7fffe375fe30
      <span class="m">1</span> 0x7fffe375fea0
.
.
.
     <span class="m">30</span> 0x7fffe375ee30
     <span class="m">30</span> 0x7fffe3760060
     <span class="m">30</span> 0x7fffe3760210
     <span class="m">30</span> 0x7fffe37603c0
     <span class="m">30</span> 0x7fffe3760570
     <span class="m">30</span> 0x7fffe3760720
     <span class="m">36</span> 0x7fffe375f220
     <span class="m">36</span> 0x7fffe3760450
     <span class="m">36</span> 0x7fffe3760600
     <span class="m">36</span> 0x7fffe3760960
     <span class="m">36</span> 0x7fffe3760b10
     <span class="m">37</span> 0x7fffe37607b0
</pre></div>


<p>Shows the number of times different errors were thrown for each of the virtual memory addresses. </p>
<p>An interesting case is 0x7fffe3760720, which happens to be the address into which all autoloads .el files are read into. Autoloads is a facility in emacs, which allows lazy loading of a preregistered function at runtime. </p>
<div class="highlight"><pre><span></span><span class="nv">$$$$</span> grep <span class="s2">&quot;^read.*0x7fffe3760720&quot;</span> emacs_strace_output <span class="p">|</span> wc -l
<span class="m">30</span>
<span class="nv">$$$$</span> grep <span class="s2">&quot;^read.*0x7fffe3760720&quot;</span> emacs_strace_output
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/ntlm-2.1.0/ntlm-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/s-20140714.707/s-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/dash-20161121.55/dash-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/s-20140714.707/s-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/dash-20161121.55/dash-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/pkg-info-20140610.630/pkg-info-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/async-20161103.1036/async-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/dash-20161121.55/dash-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/git-commit-mode-20140605.520/git-commit-mode-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/git-rebase-mode-20140605.520/git-rebase-mode-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/json-reformat-20160212.53/json-reformat-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/json-snatcher-20150511.2047/json-snatcher-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/ivy-20170202.223/ivy-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/company-20170112.2005/company-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/find-file-in-project-20161202.2205/find-file-in-project-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/highlight-indentation-20161012.209/highlight-indentation-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/pyvenv-20160527.442/pyvenv-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/yasnippet-20170127.2128/yasnippet-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/s-20140714.707/s-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/dash-20161121.55/dash-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/docker-tramp-20161020.2220/docker-tramp-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/magit-popup-20161222.428/magit-popup-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/s-20140714.707/s-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/tablist-20160424.235/tablist-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/json-mode-20160803.1606/json-mode-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/clojure-mode-20141120.1410/clojure-mode-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/clojure-mode-20141120.1410/clojure-mode-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/dash-20161121.55/dash-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/pkg-info-20140610.630/pkg-info-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
readlinkat<span class="o">(</span>AT_FDCWD, <span class="s2">&quot;/home/petr_tik/.emacs.d/elpa/queue-0.1.1/queue-autoloads.el&quot;</span>, 0x7fffe3760720, <span class="m">1024</span><span class="o">)</span> <span class="o">=</span> -1 EINVAL <span class="o">(</span>Invalid argument<span class="o">)</span>
</pre></div>


<h2>access</h2>
<h3>syscall</h3>
<p>Given a pathname string and an int for mode, check if the file at the pathname can be accessed in a given mode.</p>
<h3>source</h3>
            <a href="#" class="go-top">Go Top</a>
<footer class="footer">
    <p>&copy; Petr Tikilyaynen &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure-single">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
    </div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>

</body>
</html>